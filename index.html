<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI - Assistant Intelligent</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî∑</text></svg>">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1c0000, #000);
            color: #fff;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1a0000, #000);
            border-right: 2px solid #ffd700;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 100;
            overflow-y: auto;
        }

        #sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-bottom: 2px solid #ffd700;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sidebar-header h2 {
            margin: 0 0 10px 0;
            font-size: 1.3em;
            color: #ffd700;
            text-shadow: 2px 2px #ff0000;
        }

        #new-chat-btn {
            width: 100%;
            padding: 10px;
            background: #ff0000;
            color: #fff;
            border: 2px solid #ffd700;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        #new-chat-btn:hover {
            background: #ffd700;
            color: #000;
            transform: scale(1.02);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 12px;
            margin: 5px 0;
            background: rgba(204, 0, 0, 0.3);
            border: 1px solid #ff4444;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .conversation-item:hover {
            background: rgba(204, 0, 0, 0.5);
            border-color: #ffd700;
            transform: translateX(5px);
        }

        .conversation-item.active {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            border-width: 2px;
        }

        .conversation-title {
            font-weight: bold;
            color: #ffd700;
            font-size: 0.95em;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-date {
            font-size: 0.75em;
            color: #999;
        }

        .delete-conv-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff0000;
            color: #fff;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9em;
            display: none;
            transition: all 0.2s;
        }

        .conversation-item:hover .delete-conv-btn {
            display: block;
        }

        .delete-conv-btn:hover {
            background: #ff4444;
            transform: translateY(-50%) scale(1.1);
        }

        #toggle-sidebar {
            position: fixed;
            left: 10px;
            top: 10px;
            z-index: 200;
            background: #ff0000;
            color: #fff;
            border: 2px solid #ffd700;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        #toggle-sidebar:hover {
            background: #ffd700;
            color: #000;
        }

        #main-content {
            flex: 1;
            margin-left: 280px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        h1 {
            font-size: clamp(2em, 5vw, 3.5em);
            color: #ffd700;
            text-shadow: 3px 3px #ff0000;
            margin: 10px 0;
            animation: pulse 2s infinite;
            text-align: center;
        }

        .nexus-logo {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            letter-spacing: 3px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        #clock {
            font-size: clamp(1.2em, 3vw, 1.8em);
            color: #ff4444;
            background: #222;
            padding: 8px 15px;
            border: 2px solid #ffd700;
            border-radius: 5px;
            display: inline-block;
            margin: 5px auto;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            text-align: center;
        }
        
        .ad-banner {
            background: linear-gradient(145deg, #cc0000, #990000);
            border: 2px solid #ff4444;
            color: #fff;
            padding: 8px;
            margin: 10px auto;
            width: 90%;
            max-width: 320px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.7);
            text-align: center;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .ad-banner:hover {
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(255, 68, 68, 1);
        }
        
        .ad-banner span.star-icon {
            color: #ffd700;
            font-size: 1.5em;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .ad-dimensions {
            display: block;
            font-size: 0.9em;
            font-weight: normal;
            margin-top: 5px;
            color: #ffcccc;
        }
        
        .warning {
            color: #ff4444;
            font-size: clamp(1em, 2.5vw, 1.3em);
            font-weight: bold;
            margin: 10px auto;
            text-shadow: 1px 1px #000;
            padding: 0 10px;
            text-align: center;
        }

        .api-status {
            font-size: 0.9em;
            color: #00ff00;
            margin: 5px 0;
            padding: 5px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            display: inline-block;
            text-align: center;
        }

        #file-input {
            display: none;
        }

        .uploaded-files-container {
            margin: 10px auto;
            max-width: 600px;
            min-height: 40px;
        }

        .uploaded-file {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(204, 0, 0, 0.1));
            padding: 8px 12px;
            border-radius: 8px;
            margin: 5px;
            border: 2px solid #ffd700;
            font-size: 0.9em;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .uploaded-file .file-icon {
            margin-right: 8px;
            font-size: 1.2em;
        }

        .uploaded-file .file-name {
            color: #ffd700;
            font-weight: bold;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .uploaded-file .remove-file {
            margin-left: 12px;
            color: #ff0000;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            transition: all 0.2s;
        }

        .uploaded-file .remove-file:hover {
            color: #ff4444;
            transform: scale(1.2);
        }
        
        #chat-box {
            width: 95%;
            max-width: 900px;
            min-height: 400px;
            border: 3px solid #ffd700;
            padding: 20px;
            overflow-y: auto;
            margin: 10px auto 20px auto;
            background: linear-gradient(135deg, #0a0a0a, #1a0000);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        #chat-box::-webkit-scrollbar,
        #sidebar::-webkit-scrollbar,
        .conversations-list::-webkit-scrollbar {
            width: 10px;
        }

        #chat-box::-webkit-scrollbar-track,
        #sidebar::-webkit-scrollbar-track,
        .conversations-list::-webkit-scrollbar-track {
            background: #111;
            border-radius: 10px;
        }

        #chat-box::-webkit-scrollbar-thumb,
        #sidebar::-webkit-scrollbar-thumb,
        .conversations-list::-webkit-scrollbar-thumb {
            background: #ffd700;
            border-radius: 10px;
        }

        #chat-box::-webkit-scrollbar-thumb:hover,
        #sidebar::-webkit-scrollbar-thumb:hover,
        .conversations-list::-webkit-scrollbar-thumb:hover {
            background: #ffaa00;
        }
        
        .user-message {
            text-align: right;
            margin: 12px 0;
            padding: 12px 15px;
            background: linear-gradient(135deg, #cc0000, #990000);
            border-radius: 15px 15px 5px 15px;
            color: #fff;
            max-width: 75%;
            margin-left: auto;
            font-size: 1em;
            word-wrap: break-word;
            box-shadow: 0 3px 10px rgba(204, 0, 0, 0.5);
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .bot-message {
            text-align: left;
            margin: 12px 0;
            padding: 12px 15px;
            background: linear-gradient(135deg, #004400, #002200);
            border-radius: 15px 15px 15px 5px;
            color: #fff;
            max-width: 75%;
            margin-right: auto;
            font-size: 1em;
            word-wrap: break-word;
            line-height: 1.6;
            box-shadow: 0 3px 10px rgba(0, 68, 0, 0.5);
            animation: slideInLeft 0.3s;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .bot-message strong {
            color: #ffd700;
            font-weight: bold;
        }

        .bot-message em {
            color: #ffaa00;
            font-style: italic;
        }

        .bot-message ul, .bot-message ol {
            text-align: left;
            margin: 10px 0;
            padding-left: 20px;
        }

        .bot-message li {
            margin: 5px 0;
        }

        .bot-message code {
            background: #222;
            padding: 2px 6px;
            border-radius: 3px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }

        .bot-message pre {
            background: #222;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 3px solid #ffd700;
            margin: 10px 0;
        }

        .bot-message pre code {
            background: none;
            padding: 0;
        }

        .bot-message h1, .bot-message h2, .bot-message h3 {
            color: #ffd700;
            margin: 10px 0 5px 0;
        }

        .bot-message blockquote {
            border-left: 3px solid #ffd700;
            padding-left: 10px;
            margin: 10px 0;
            color: #ccc;
            font-style: italic;
        }

        .bot-message a {
            color: #00ccff;
            text-decoration: underline;
        }

        .bot-message p {
            margin: 8px 0;
        }
        
        .typing-indicator {
            text-align: left;
            margin: 12px 0;
            padding: 12px 15px;
            background: linear-gradient(135deg, #004400, #002200);
            border-radius: 15px 15px 15px 5px;
            color: #fff;
            max-width: 70%;
            margin-right: auto;
            font-size: 1.1em;
        }
        
        .typing-indicator span {
            animation: blink 1.4s infinite;
            opacity: 0;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes blink {
            0%, 60%, 100% { opacity: 0; }
            30% { opacity: 1; }
        }
        
        #input-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px auto 30px auto;
            width: 95%;
            max-width: 900px;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(204, 0, 0, 0.1));
            border-radius: 15px;
            border: 2px solid #ffd700;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.2);
            position: sticky;
            bottom: 10px;
            z-index: 50;
        }

        #attach-file-btn {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #00cc00, #009900);
            border: 2px solid #ffd700;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
        }

        #attach-file-btn:hover {
            background: linear-gradient(135deg, #00ff00, #00cc00);
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.5);
        }

        #attach-file-btn svg {
            width: 24px;
            height: 24px;
            transition: all 0.3s;
        }

        #attach-file-btn:hover svg {
            transform: rotate(-90deg);
        }
        
        #user-input {
            padding: 12px 15px;
            font-size: 1.1em;
            border: 2px solid #ffd700;
            background: #1a1a1a;
            color: #fff;
            border-radius: 10px;
            flex: 1;
            min-width: 150px;
            transition: all 0.3s;
        }

        #user-input:focus {
            outline: none;
            border-color: #ffaa00;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        #send-button {
            padding: 12px 25px;
            font-size: 1.1em;
            background: linear-gradient(135deg, #ff0000, #cc0000);
            color: #fff;
            border: 2px solid #ffd700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            font-weight: bold;
        }
        
        #send-button:hover {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
        }
        
        #send-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: scale(1);
            box-shadow: none;
        }
        
        .footer {
            text-align: center;
            width: 100%;
            color: #666;
            font-size: 0.8em;
            text-shadow: 1px 1px #000;
            padding: 20px 0;
        }

        .footer .nexus-brand {
            color: #ffd700;
            font-weight: bold;
        }

        .center-content {
            text-align: center;
        }
        
        @media (max-width: 768px) {
            #sidebar {
                width: 100%;
                z-index: 1000;
            }

            #main-content {
                margin-left: 0;
                padding: 10px;
                padding-top: 60px;
            }

            #toggle-sidebar {
                display: block;
            }
            
            h1 {
                font-size: 2em;
                margin: 5px 0;
            }
            
            #chat-box {
                padding: 10px;
                min-height: 300px;
            }
            
            .user-message, .bot-message {
                font-size: 0.95em;
                padding: 10px;
                max-width: 85%;
            }
            
            #input-container {
                gap: 5px;
                padding: 10px;
                position: sticky;
                bottom: 0;
            }
            
            #user-input {
                font-size: 1em;
                padding: 10px;
            }
            
            #send-button {
                padding: 10px 15px;
                font-size: 1em;
            }

            #attach-file-btn {
                width: 40px;
                height: 40px;
            }

            #attach-file-btn svg {
                width: 20px;
                height: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .ad-banner {
                font-size: 0.9em;
                padding: 6px;
            }
            
            .warning {
                font-size: 0.9em;
            }

            .conversation-title {
                font-size: 0.85em;
            }

            .uploaded-file .file-name {
                max-width: 120px;
            }
        }

        @media (min-width: 769px) {
            #toggle-sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header">
            <h2>üí¨ Conversations Nexus</h2>
            <button id="new-chat-btn">‚ûï Nouvelle conversation</button>
        </div>
        <div class="conversations-list" id="conversations-list"></div>
    </div>

    <button id="toggle-sidebar">‚ò∞</button>

    <div id="main-content">
        <div class="center-content">
            <h1><span class="nexus-logo">NEXUS</span> AI</h1>
            <div id="clock"></div>

            <div class="ad-banner">
                <span class="star-icon">‚≠ê</span> Espace Publicitaire Nexus
                <span class="ad-dimensions">320x50 / 320x100</span>
            </div>

            <div class="api-status">üü¢ Nexus AI Connect√© (Llama 3.3 - 70B)</div>
            
            <p class="warning">Tape "1h" pour un ticket ou pose n'importe quelle question √† Nexus AI !</p>
        </div>

        <div class="uploaded-files-container" id="uploaded-files"></div>

        <div id="chat-box"></div>

        <div id="input-container">
            <input type="file" id="file-input" accept=".txt,.pdf,.doc,.docx,.jpg,.png,.jpeg,.gif,.xlsx,.xls" multiple>
            
            <button id="attach-file-btn" title="Joindre des fichiers">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5V19M5 12H19" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            
            <input type="text" id="user-input" placeholder="Parle avec Nexus AI...">
            <button id="send-button">Envoyer</button>
        </div>

        <div class="footer">
            <span class="nexus-brand">NEXUS</span> - IA Avanc√©e gratuite - Propuls√© par Groq (Llama 3.3)
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const clock = document.getElementById('clock');
        const conversationsList = document.getElementById('conversations-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const sidebar = document.getElementById('sidebar');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        const fileInput = document.getElementById('file-input');
        const attachFileBtn = document.getElementById('attach-file-btn');
        const uploadedFilesDiv = document.getElementById('uploaded-files');
        
        const apiKey = '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';
        
        let conversations = JSON.parse(localStorage.getItem('nexus_conversations')) || [];
        let currentConversationId = null;
        let attachedFiles = [];

        if (conversations.length === 0) {
            createNewConversation();
        } else {
            loadConversation(conversations[0].id);
        }
        renderConversationsList();

        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
        });

        if (window.innerWidth <= 768) {
            conversationsList.addEventListener('click', () => {
                sidebar.classList.add('hidden');
            });
        }

        attachFileBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    attachedFiles.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        content: event.target.result
                    });
                    renderUploadedFiles();
                };
                
                if (file.type.startsWith('text/') || file.name.endsWith('.txt')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsDataURL(file);
                }
            });
            fileInput.value = '';
        });

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'txt': 'üìÑ',
                'pdf': 'üìï',
                'doc': 'üìò',
                'docx': 'üìò',
                'jpg': 'üñºÔ∏è',
                'jpeg': 'üñºÔ∏è',
                'png': 'üñºÔ∏è',
                'gif': 'üñºÔ∏è',
                'xlsx': 'üìä',
                'xls': 'üìä',
                'csv': 'üìä'
            };
            return icons[ext] || 'üìé';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function renderUploadedFiles() {
            uploadedFilesDiv.innerHTML = '';
            attachedFiles.forEach((file, index) => {
                const fileEl = document.createElement('div');
                fileEl.className = 'uploaded-file';
                fileEl.innerHTML = `
                    <span class="file-icon">${getFileIcon(file.name)}</span>
                    <span class="file-name" title="${file.name}">${file.name}</span>
                    <span style="color: #999; font-size: 0.85em; margin-left: 8px;">${formatFileSize(file.size)}</span>
                    <span class="remove-file" onclick="removeFile(${index})">‚úï</span>
                `;
                uploadedFilesDiv.appendChild(fileEl);
            });
        }

        window.removeFile = function(index) {
            attachedFiles.splice(index, 1);
            renderUploadedFiles();
        };

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            clock.textContent = `${hours}:${minutes}:${seconds}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        function createNewConversation() {
            const conversation = {
                id: Date.now().toString(),
                title: 'Nouvelle conversation',
                messages: [],
                history: [],
                createdAt: new Date().toISOString()
            };
            conversations.unshift(conversation);
            saveConversations();
            loadConversation(conversation.id);
            renderConversationsList();
        }

        function loadConversation(id) {
            currentConversationId = id;
            const conversation = conversations.find(c => c.id === id);
            if (!conversation) return;

            chatBox.innerHTML = '';
            conversation.messages.forEach(msg => {
                if (msg.type === 'user') {
                    addMessage('user-message', msg.content);
                } else {
                    addMessage('bot-message', msg.content, true);
                }
            });

            renderConversationsList();
            
            setTimeout(() => {
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 100);
        }

        function saveConversations() {
            localStorage.setItem('nexus_conversations', JSON.stringify(conversations));
        }

        function getCurrentConversation() {
            return conversations.find(c => c.id === currentConversationId);
        }

        function updateConversationTitle(message) {
            const conversation = getCurrentConversation();
            if (conversation && conversation.messages.length === 1) {
                conversation.title = message.substring(0, 30) + (message.length > 30 ? '...' : '');
                saveConversations();
                renderConversationsList();
            }
        }

        function deleteConversation(id, event) {
            event.stopPropagation();
            if (confirm('Supprimer cette conversation ?')) {
                conversations = conversations.filter(c => c.id !== id);
                saveConversations();
                
                if (currentConversationId === id) {
                    if (conversations.length === 0) {
                        createNewConversation();
                    } else {
                        loadConversation(conversations[0].id);
                    }
                }
                renderConversationsList();
            }
        }

        function renderConversationsList() {
            conversationsList.innerHTML = '';
            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item' + (conv.id === currentConversationId ? ' active' : '');
                
                const date = new Date(conv.createdAt);
                const dateStr = date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: '2-digit' });
                const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                
                item.innerHTML = `
                    <div class="conversation-title">${conv.title}</div>
                    <div class="conversation-date">${dateStr} ${timeStr}</div>
                    <button class="delete-conv-btn" onclick="deleteConversation('${conv.id}', event)">‚úï</button>
                `;
                
                item.addEventListener('click', () => loadConversation(conv.id));
                conversationsList.appendChild(item);
            });
        }

        newChatBtn.addEventListener('click', createNewConversation);

        function markdownToHTML(text) {
            text = text.replace(/```(\w+)?\n([\s\S]+?)```/g, '<pre><code>$2</code></pre>');
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            text = text.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            text = text.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            text = text.replace(/^[\-\*]\s+(.+)$/gm, '<li>$1</li>');
            text = text.replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>');
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            text = text.split('\n\n').map(para => {
                if (!para.trim().startsWith('<')) {
                    return '<p>' + para + '</p>';
                }
                return para;
            }).join('\n');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        function addMessage(className, message, isHTML = false) {
            const msg = document.createElement('div');
            msg.className = className;
            
            if (isHTML) {
                msg.innerHTML = message;
            } else {
                msg.textContent = message;
            }
            
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;

            const conversation = getCurrentConversation();
            if (conversation && !isHTML) {
                conversation.messages.push({
                    type: className.includes('user') ? 'user' : 'bot',
                    content: message
                });
                saveConversations();
            } else if (conversation && isHTML && !conversation.messages.find(m => m.content === message)) {
                conversation.messages.push({
                    type: 'bot',
                    content: message
                });
                saveConversations();
            }

            return msg;
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typing';
            indicator.innerHTML = '<span>‚óè</span><span>‚óè</span><span>‚óè</span>';
            chatBox.appendChild(indicator);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing');
            if (indicator) {
                indicator.remove();
            }
        }

        function formatDate(date) {
            return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getFullYear()).slice(-2)}`;
        }

        function formatTime(date) {
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function generateRandomSequence() {
            return Array.from({ length: 6 }, () =>
                String(Math.floor(Math.random() * 100)).padStart(2, '0')
            ).join("'");
        }

        function generateRandomLetter() {
            return String.fromCharCode(65 + Math.floor(Math.random() * 26));
        }

        function generateRandomCode() {
            const letter1 = generateRandomLetter();
            let letter2, letter3;
            do {
                letter2 = generateRandomLetter();
            } while (letter2 === letter1);
            do {
                letter3 = generateRandomLetter();
            } while (letter3 === letter1 || letter3 === letter2);
            const digit = Math.floor(Math.random() * 10);
            return `${letter1}${digit}${letter2}${letter3}`;
        }

        async function getGroqAIResponse(message) {
            try {
                const conversation = getCurrentConversation();
                
                let fullMessage = message;
                if (attachedFiles.length > 0) {
                    fullMessage += '\n\n[Fichiers joints:]\n';
                    attachedFiles.forEach(file => {
                        fullMessage += `\nFichier: ${file.name} (${formatFileSize(file.size)})\n`;
                        if (file.type.startsWith('text/') || file.name.endsWith('.txt')) {
                            fullMessage += `Contenu:\n${file.content}\n`;
                        } else {
                            fullMessage += `Type: ${file.type}\n`;
                        }
                    });
                }
                
                conversation.history.push({
                    role: "user",
                    content: fullMessage
                });

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            {
                                role: "system",
                                content: `Tu es Nexus AI, un assistant IA intelligent, sympa et utile cr√©√© par l'entreprise Nexus. Tu r√©ponds en fran√ßais. 

IMPORTANT: Tu PEUX et tu DOIS analyser, lire et traiter TOUS les types de fichiers que l'utilisateur te partage, incluant:
- Documents Word (.doc, .docx)
- Fichiers texte (.txt)
- Images (.jpg, .png, .jpeg, .gif)
- PDFs
- Tableurs Excel
- Tout autre type de fichier

Quand l'utilisateur partage un fichier:
1. Confirme que tu as bien re√ßu le fichier
2. Analyse son contenu en d√©tail
3. R√©ponds aux questions de l'utilisateur concernant ce fichier
4. Propose des am√©liorations ou des analyses si pertinent

Ne dis JAMAIS que tu ne peux pas traiter un fichier. Tu es capable de tout analyser.

Tu peux parler de tout comme ChatGPT ou Gemini. Sois naturel, pr√©cis et conversationnel. R√©ponds de mani√®re claire et concise. Tu peux utiliser le formatage Markdown dans tes r√©ponses.

Tu es fier de repr√©senter Nexus et tu mentionnes parfois que tu es Nexus AI quand c'est appropri√©.`
                            },
                            ...conversation.history
                        ],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erreur API:', errorData);
                    if (response.status === 401) {
                        return "‚ùå Cl√© API invalide. V√©rifie ta configuration.";
                    }
                    return "‚ùå Erreur de connexion √† Nexus AI. R√©essaie dans quelques secondes.";
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                conversation.history.push({
                    role: "assistant",
                    content: aiResponse
                });

                if (conversation.history.length > 20) {
                    conversation.history = conversation.history.slice(-20);
                }

                saveConversations();
                
                attachedFiles = [];
                renderUploadedFiles();
                
                return aiResponse;
            } catch (error) {
                console.error('Erreur:', error);
                return "‚ùå Erreur de connexion. V√©rifie ta connexion internet.";
            }
        }

        async function handleMessage() {
            const message = userInput.value.trim();
            if (!message && attachedFiles.length === 0) return;

            sendButton.disabled = true;
            userInput.disabled = true;

            const displayMessage = message || '[Fichier(s) envoy√©(s)]';
            addMessage('user-message', displayMessage);
            updateConversationTitle(displayMessage);
            userInput.value = '';

            if (message === '1h' && attachedFiles.length === 0) {
                const now = new Date();
                const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);

                const ticket = `Titre 1 voyage\n\nValable 1 heure d√®s r√©ception du SMS\nLe ${formatDate(now)}\nDe ${formatTime(now)} √† ${formatTime(oneHourLater)}\n\n1.35 E\n\n${generateRandomSequence()}\n\n0783643942${generateRandomCode()}\n\nCGV : www.tcat.fr/cgv-ticket-sms`;

                setTimeout(() => {
                    addMessage('bot-message', ticket);
                    sendButton.disabled = false;
                    userInput.disabled = false;
                    userInput.focus();
                }, 1000);

                navigator.clipboard.writeText(ticket)
                    .then(() => console.log('Ticket copi√©'))
                    .catch(err => console.error('Erreur copie:', err));
            } else {
                showTypingIndicator();
                
                const aiResponse = await getGroqAIResponse(message || 'Analyse ces fichiers');
                
                hideTypingIndicator();
                
                const formattedResponse = markdownToHTML(aiResponse);
                addMessage('bot-message', formattedResponse, true);
                
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        sendButton.addEventListener('click', handleMessage);

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                handleMessage();
            }
        });
    </script>
</body>
</html>
