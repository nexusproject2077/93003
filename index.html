<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Ticket avec IA Avanc√©e</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1c0000, #000);
            color: #fff;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 10px;
            text-align: center;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        h1 {
            font-size: clamp(2em, 5vw, 3.5em);
            color: #ffd700;
            text-shadow: 3px 3px #ff0000;
            margin: 10px 0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        #clock {
            font-size: clamp(1.2em, 3vw, 1.8em);
            color: #ff4444;
            background: #222;
            padding: 8px 15px;
            border: 2px solid #ffd700;
            border-radius: 5px;
            display: inline-block;
            margin: 5px auto;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        .ad-banner {
            background: linear-gradient(145deg, #cc0000, #990000);
            border: 2px solid #ff4444;
            color: #fff;
            padding: 8px;
            margin: 10px auto;
            width: 90%;
            max-width: 320px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.7);
            text-align: center;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .ad-banner:hover {
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(255, 68, 68, 1);
        }
        
        .ad-banner span.star-icon {
            color: #ffd700;
            font-size: 1.5em;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .ad-dimensions {
            display: block;
            font-size: 0.9em;
            font-weight: normal;
            margin-top: 5px;
            color: #ffcccc;
        }
        
        .warning {
            color: #ff4444;
            font-size: clamp(1em, 2.5vw, 1.3em);
            font-weight: bold;
            margin: 10px auto;
            text-shadow: 1px 1px #000;
            padding: 0 10px;
        }

        .api-status {
            font-size: 0.9em;
            color: #00ff00;
            margin: 5px 0;
            padding: 5px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            display: inline-block;
        }
        
        #chat-box {
            width: 90%;
            max-width: 600px;
            flex: 1;
            min-height: 200px;
            max-height: calc(100vh - 400px);
            border: 3px solid #ffd700;
            padding: 15px;
            overflow-y: auto;
            margin: 10px auto;
            background: #111;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
        }
        
        .user-message {
            text-align: right;
            margin: 8px 12px;
            padding: 10px;
            background: #cc0000;
            border-radius: 8px;
            color: #fff;
            max-width: 80%;
            margin-left: auto;
            font-size: 1em;
            word-wrap: break-word;
        }
        
        .bot-message {
            text-align: left;
            margin: 8px 12px;
            padding: 10px;
            background: #004400;
            border-radius: 8px;
            color: #fff;
            max-width: 80%;
            margin-right: auto;
            font-size: 1em;
            word-wrap: break-word;
            line-height: 1.6;
        }

        /* Formatage Markdown dans les messages */
        .bot-message strong {
            color: #ffd700;
            font-weight: bold;
        }

        .bot-message em {
            color: #ffaa00;
            font-style: italic;
        }

        .bot-message ul, .bot-message ol {
            text-align: left;
            margin: 10px 0;
            padding-left: 20px;
        }

        .bot-message li {
            margin: 5px 0;
        }

        .bot-message code {
            background: #222;
            padding: 2px 6px;
            border-radius: 3px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }

        .bot-message pre {
            background: #222;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 3px solid #ffd700;
            margin: 10px 0;
        }

        .bot-message pre code {
            background: none;
            padding: 0;
        }

        .bot-message h1, .bot-message h2, .bot-message h3 {
            color: #ffd700;
            margin: 10px 0 5px 0;
        }

        .bot-message blockquote {
            border-left: 3px solid #ffd700;
            padding-left: 10px;
            margin: 10px 0;
            color: #ccc;
            font-style: italic;
        }

        .bot-message a {
            color: #00ccff;
            text-decoration: underline;
        }

        .bot-message p {
            margin: 8px 0;
        }
        
        .typing-indicator {
            text-align: left;
            margin: 8px 12px;
            padding: 10px;
            background: #004400;
            border-radius: 8px;
            color: #fff;
            max-width: 70%;
            margin-right: auto;
            font-size: 1.1em;
        }
        
        .typing-indicator span {
            animation: blink 1.4s infinite;
            opacity: 0;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes blink {
            0%, 60%, 100% { opacity: 0; }
            30% { opacity: 1; }
        }
        
        #input-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px auto;
            width: 90%;
            max-width: 600px;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }
        
        #user-input {
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #ffd700;
            background: #222;
            color: #fff;
            border-radius: 5px;
            flex: 1;
            min-width: 150px;
        }
        
        #send-button {
            padding: 12px 20px;
            font-size: 1.1em;
            background: #ff0000;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        #send-button:hover {
            background: #ffd700;
            color: #000;
            transform: scale(1.05);
        }
        
        #send-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: scale(1);
        }
        
        .footer {
            position: relative;
            width: 100%;
            color: #666;
            font-size: 0.8em;
            text-shadow: 1px 1px #000;
            padding: 10px 0;
            margin-top: auto;
        }
        
        /* Media queries pour mobile */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            h1 {
                margin: 5px 0;
            }
            
            #chat-box {
                max-height: calc(100vh - 380px);
                padding: 10px;
            }
            
            .user-message, .bot-message {
                font-size: 0.95em;
                padding: 8px;
                margin: 6px 8px;
            }
            
            #input-container {
                gap: 5px;
                padding: 5px;
            }
            
            #user-input {
                font-size: 1em;
                padding: 10px;
            }
            
            #send-button {
                padding: 10px 15px;
                font-size: 1em;
            }
        }
        
        @media (max-width: 480px) {
            #chat-box {
                max-height: calc(100vh - 360px);
            }
            
            .ad-banner {
                font-size: 0.9em;
                padding: 6px;
            }
            
            .warning {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <h1>G√âN√âRATEUR + IA AVANC√âE</h1>
    <div id="clock"></div>

    <div class="ad-banner">
        <span class="star-icon">‚≠ê</span> Banni√®re Publicitaire
        <span class="ad-dimensions">320x50 / 320x100 (Espace Publicitaire)</span>
    </div>

    <div class="api-status">üü¢ IA Connect√©e (Llama 3.3 - 70B)</div>
    
    <p class="warning">Tape "1h" pour un ticket ou pose n'importe quelle question √† l'IA !</p>

    <div id="chat-box"></div>

    <div id="input-container">
        <input type="text" id="user-input" placeholder="Tape un message">
        <button id="send-button">Envoyer</button>
    </div>

    <div class="footer">
        IA Avanc√©e gratuite - Propuls√© par Groq (Llama 3.3)
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const clock = document.getElementById('clock');
        
        let conversationHistory = [];
        const apiKey = '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';

        // Message de bienvenue
        addMessage('bot-message', "Salut ! Je suis une IA avanc√©e comme ChatGPT. Pose-moi n'importe quelle question ou tape '1h' pour g√©n√©rer un ticket !");

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            clock.textContent = `${hours}:${minutes}:${seconds}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Fonction pour convertir le Markdown en HTML
        function markdownToHTML(text) {
            // Blocs de code avec ```
            text = text.replace(/```(\w+)?\n([\s\S]+?)```/g, '<pre><code>$2</code></pre>');
            
            // Code inline avec `
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Gras **texte**
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Italique *texte*
            text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Titres
            text = text.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            
            // Listes num√©rot√©es
            text = text.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            
            // Listes √† puces
            text = text.replace(/^[\-\*]\s+(.+)$/gm, '<li>$1</li>');
            
            // Citations
            text = text.replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>');
            
            // Liens [texte](url)
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Sauts de ligne doubles en paragraphes
            text = text.split('\n\n').map(para => {
                if (!para.trim().startsWith('<')) {
                    return '<p>' + para + '</p>';
                }
                return para;
            }).join('\n');
            
            // Sauts de ligne simples
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        function addMessage(className, message, isHTML = false) {
            const msg = document.createElement('div');
            msg.className = className;
            
            if (isHTML) {
                msg.innerHTML = message;
            } else {
                msg.textContent = message;
            }
            
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
            return msg;
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typing';
            indicator.innerHTML = '<span>‚óè</span><span>‚óè</span><span>‚óè</span>';
            chatBox.appendChild(indicator);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing');
            if (indicator) {
                indicator.remove();
            }
        }

        function formatDate(date) {
            return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getFullYear()).slice(-2)}`;
        }

        function formatTime(date) {
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function generateRandomSequence() {
            return Array.from({ length: 6 }, () =>
                String(Math.floor(Math.random() * 100)).padStart(2, '0')
            ).join("'");
        }

        function generateRandomLetter() {
            return String.fromCharCode(65 + Math.floor(Math.random() * 26));
        }

        function generateRandomCode() {
            const letter1 = generateRandomLetter();
            let letter2, letter3;
            do {
                letter2 = generateRandomLetter();
            } while (letter2 === letter1);
            do {
                letter3 = generateRandomLetter();
            } while (letter3 === letter1 || letter3 === letter2);
            const digit = Math.floor(Math.random() * 10);
            return `${letter1}${digit}${letter2}${letter3}`;
        }

        async function getGroqAIResponse(message) {
            try {
                conversationHistory.push({
                    role: "user",
                    content: message
                });

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            {
                                role: "system",
                                content: "Tu es un assistant IA intelligent, sympa et utile qui r√©pond en fran√ßais. Tu peux parler de tout comme ChatGPT ou Gemini. Sois naturel, pr√©cis et conversationnel. R√©ponds de mani√®re claire et concise. Tu peux utiliser le formatage Markdown dans tes r√©ponses."
                            },
                            ...conversationHistory
                        ],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erreur API:', errorData);
                    if (response.status === 401) {
                        return "‚ùå Cl√© API invalide. V√©rifie ta configuration.";
                    }
                    return "‚ùå Erreur de connexion √† l'IA. R√©essaie dans quelques secondes.";
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                conversationHistory.push({
                    role: "assistant",
                    content: aiResponse
                });

                // Limiter l'historique √† 20 messages pour √©viter les tokens excessifs
                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }

                return aiResponse;
            } catch (error) {
                console.error('Erreur:', error);
                return "‚ùå Erreur de connexion. V√©rifie ta connexion internet.";
            }
        }

        async function handleMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            sendButton.disabled = true;
            userInput.disabled = true;

            addMessage('user-message', message);
            userInput.value = '';

            if (message === '1h') {
                const now = new Date();
                const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);

                const ticket = `Titre 1 voyage\n\nValable 1 heure d√®s r√©ception du SMS\nLe ${formatDate(now)}\nDe ${formatTime(now)} √† ${formatTime(oneHourLater)}\n\n1.35 E\n\n${generateRandomSequence()}\n\n0783643942${generateRandomCode()}\n\nCGV : www.tcat.fr/cgv-ticket-sms`;

                setTimeout(() => {
                    addMessage('bot-message', ticket);
                    sendButton.disabled = false;
                    userInput.disabled = false;
                    userInput.focus();
                }, 1000);

                navigator.clipboard.writeText(ticket)
                    .then(() => console.log('Ticket copi√©'))
                    .catch(err => console.error('Erreur copie:', err));
            } else {
                showTypingIndicator();
                
                const aiResponse = await getGroqAIResponse(message);
                
                hideTypingIndicator();
                
                // Convertir le Markdown en HTML
                const formattedResponse = markdownToHTML(aiResponse);
                addMessage('bot-message', formattedResponse, true);
                
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        sendButton.addEventListener('click', handleMessage);

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                handleMessage();
            }
        });
    </script>
</body>
</html>
